<!doctype html>
<html lang="en">

<head>
    <meta charset=utf-8 />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/async/2.1.4/async.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.js"></script>
    <script>
        var style = {
            stroke: true,
            color: 'blue',
            opacity: 0.5,
            dashArray: '8, 5',
            fillColor: 'blue',
            fillOpacity: 0.0,
            weight: 2
        };

        function exec(text) {
            clearMap();

            search(text, function (result) {
                result = result || [];
                render(result.bbox, result.features);
            });
        }

        function clearMap() {
            console.info('Clearing map');
            document.layer.clearLayers();
            document.poiLayer.clearLayers();
        }

        function search(text, cb) {
            console.info('Requesting Pelias');
            $.ajax({
                url: 'http://localhost:4000/v1/search',
                method: 'GET',
                data: { text: text, size: 25, 'boundary.circle.lat': 48.853, 'boundary.circle.lon': 2.35, 'boundary.circle.radius': 10 },
                headers: { 'Accept': 'application/json' }
            }).done(cb);
        }

        function render(bbox, features) {
            console.info('Rendering pois and map');
            var filtered = _.filter(features, function (feature) {
                return (feature.properties.confidence >= 0.9);
            });
            _.each(filtered, function (feature) {
                L.marker([feature.geometry.coordinates[1], feature.geometry.coordinates[0]]).bindPopup(feature.properties.name).addTo(document.poiLayer);
            });
            updateMap(bbox);
        }

        function updateMap(bbox) {
            var area = [[bbox[1], bbox[0]], [bbox[3], bbox[2]]];
            var rect = L.rectangle(area, style);
            rect.addTo(document.layer);
            document.map.fitBounds(document.layer.getBounds());
        }

        $(document).ready(function () {
            $('#search').on('submit', function (e) {
                exec($('#text').val());
                return false;
            });

            $('#go').on('click', function (e) {
                $('#search').submit();
                return false;
            });

            var map = L.map('map', { zoomControl: false });
            var tiles = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';

            L.tileLayer(tiles, {
                scrollWheelZoom: true,
                attributionControl: false,
            }).addTo(map);

            map.setView(new L.LatLng(48.853, 2.35), 12);

            var bboxLayer = L.geoJson();
            bboxLayer.addTo(map);

            var poiLayer = new L.LayerGroup();
            poiLayer.addTo(map);

            document.map = map;
            document.layer = bboxLayer;
            document.poiLayer = poiLayer;
        });
    </script>
</head>

<body>
    <div style="margin:20px;">
        <form id="search" action="">
            <div class="row">
                <div class="col-md-4">
                    <div class="input-group" style="position: relative; margin: 10px;">
                        <input id="text" type="text" class="form-control" placeholder="Search for...">
                        <span class="input-group-btn">
                            <button id="go" class="btn btn-default" type="button">Rechercher</button>
                        </span>
                    </div>
                    <!-- /input-group -->
                </div>
                <!-- /.col-md-6 -->
                <div class="col-md-12" style="position: absolute; z-index: 0">
                    <div id="map" style="width:100%; height:100%; height: 90vh;" />
                </div>
                <!-- /.col-md-6 -->
            </div>
            <!-- /.row -->
        </form>
    </div>
</body>

</html>
